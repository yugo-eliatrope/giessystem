# üå± GiesSystem

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏, –∞ —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º –Ω–∞ –±–∞–∑–µ Arduino —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üå°Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ (DHT11)
- üíß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–º —á–µ—Ä–µ–∑ —Ä–µ–ª–µ
- üìä –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

## –°—Ö–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Arduino

```
Arduino Uno/Nano
‚îú‚îÄ‚îÄ Pin 2  ‚Üí DHT11 (Data)
‚îú‚îÄ‚îÄ Pin 7  ‚Üí Relay Module (IN)
‚îú‚îÄ‚îÄ 5V     ‚Üí DHT11 (VCC), Relay (VCC)
‚îî‚îÄ‚îÄ GND    ‚Üí DHT11 (GND), Relay (GND)
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. Arduino

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `DHT sensor library` —á–µ—Ä–µ–∑ Arduino IDE
2. –û—Ç–∫—Ä–æ–π—Ç–µ `arduino/app.ino`
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–µ—Ç—á –Ω–∞ –ø–ª–∞—Ç—É

### 2. –°–µ—Ä–≤–µ—Ä

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
yarn install

# –°–±–æ—Ä–∫–∞
yarn build
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
DATABASE_URL="file:./dev.db"
SERIAL_PORT_PATH=/dev/ttyUSB0
SERIAL_BAUD_RATE=9600
HTTP_SERVER_PORT=3000

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
# –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
AUTH_PASSWORD=your_secret_password
```

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `DATABASE_URL` | ‚úì | –ü—É—Ç—å –∫ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö |
| `SERIAL_PORT_PATH` | ‚úì | –ü—É—Ç—å –∫ Serial –ø–æ—Ä—Ç—É Arduino |
| `SERIAL_BAUD_RATE` | ‚úì | –°–∫–æ—Ä–æ—Å—Ç—å Serial —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ 9600) |
| `HTTP_SERVER_PORT` | ‚úì | –ü–æ—Ä—Ç HTTP —Å–µ—Ä–≤–µ—Ä–∞ |
| `AUTH_PASSWORD` | ‚Äî | –ü–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ |

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—É—Ç—å –∫ Serial –ø–æ—Ä—Ç—É –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –û–°:
> - Linux: `/dev/ttyUSB0` –∏–ª–∏ `/dev/ttyACM0`
> - macOS: `/dev/cu.usbserial-*` –∏–ª–∏ `/dev/cu.usbmodem*`
> - Windows: `COM3`, `COM4`, –∏ —Ç.–¥.

### 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQLite —á–µ—Ä–µ–∑ Prisma. –î–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î:

```bash
# –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ö–µ–º–µ
yarn db:push
```

–î—Ä—É–≥–∏–µ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ (Prisma Studio)
yarn db:studio

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–ª—è production)
yarn db:migrate
```

### 5. –ó–∞–ø—É—Å–∫

```bash
# Production
yarn start

# Development
yarn dev
```

–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:3000` (–µ—Å–ª–∏ `SERVER_PORT=3000`)

## API

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/` | GET | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ (–µ—Å–ª–∏ AUTH_PASSWORD –∑–∞–¥–∞–Ω) |
| `/login` | POST | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è `{ password: string }` |
| `/logout` | GET | –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã |
| `/app` | GET | –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) |
| `/info` | WebSocket | Live-–¥–∞–Ω–Ω—ã–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≥–æ–≤ |
| `/pump?time=N` | GET | –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å –Ω–∞ N —Å–µ–∫—É–Ω–¥ (2-32) |

## –£–¥–∞–ª—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SSH —Ç—É–Ω–Ω–µ–ª—å

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –¥–æ–º–∞—à–Ω–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –º–æ–∂–Ω–æ –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ VPS –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑–≤–Ω–µ.

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤:

```bash
sudo nano /etc/ssh/sshd_config
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ/–¥–æ–±–∞–≤—å—Ç–µ:

```
AllowTcpForwarding yes
GatewayPorts yes
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ SSH:

```bash
sudo systemctl restart sshd
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ autossh

–ù–∞ –¥–æ–º–∞—à–Ω–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
# Debian/Ubuntu
sudo apt install autossh

# macOS
brew install autossh
```

### 3. –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è

```bash
autossh -M 0 -N -R 0.0.0.0:3000:localhost:3000 user@VPS_IP
```

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `-M 0` ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ä—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ServerAliveInterval)
- `-N` ‚Äî –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±—Ä–æ—Å
- `-R 0.0.0.0:3000:localhost:3000` ‚Äî –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ 3000 VPS –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π 3000

### 4. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ (systemd)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/systemd/system/giessystem-tunnel.service`:

```ini
[Unit]
Description=GiesSystem SSH Tunnel
After=network.target

[Service]
User=YOUR_USER
ExecStart=/usr/bin/autossh -M 0 -N -o "ServerAliveInterval 30" -o "ServerAliveCountMax 3" -R 0.0.0.0:3000:localhost:3000 user@VPS_IP
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ:

```bash
sudo systemctl enable giessystem-tunnel
sudo systemctl start giessystem-tunnel
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ** —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏–Ω–æ–π —Å–æ–±—ã—Ç–∏–π.

### EventBus

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî `EventBus` ‚Äî —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `EventEmitter`:

```typescript
type AppEvents = {
  'sensor:data': UnsavedSensorReading;  // –î–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç—á–∏–∫–æ–≤
  'pump:activate': { time: number };     // –ö–æ–º–∞–Ω–¥–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å–æ—Å–∞
  'log:entry': { message: string };      // –õ–æ–≥-—Å–æ–æ–±—â–µ–Ω–∏–µ
};
```

### Orchestrator

`Orchestrator` —Å–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–æ–±—ã—Ç–∏—è:

| –ü–æ—Ç–æ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `sensor:data` ‚Üí Database ‚Üí WebSocket | –î–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç—á–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º |
| `pump:activate` ‚Üí Serial | –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ Arduino |
| `log:entry` ‚Üí Database ‚Üí WebSocket | –õ–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º |

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è. WebSocket, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ —Å–æ–±—ã—Ç–∏—è, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç live –¥–∞–Ω–Ω—ã–µ –≤ UI.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
giessystem/
‚îú‚îÄ‚îÄ arduino/
‚îÇ   ‚îî‚îÄ‚îÄ app.ino              # –°–∫–µ—Ç—á –¥–ª—è Arduino
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma        # –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ dev.db               # SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts             # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ config.ts            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
‚îÇ   ‚îú‚îÄ‚îÄ event-bus.ts         # –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.ts      # –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ http-server.ts       # HTTP —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ websocket-server.ts  # WebSocket —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ serial-manager.ts    # –†–∞–±–æ—Ç–∞ —Å Serial –ø–æ—Ä—Ç–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ database-manager.ts  # –†–∞–±–æ—Ç–∞ —Å Prisma/SQLite
‚îÇ   ‚îú‚îÄ‚îÄ parser.ts            # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Arduino
‚îÇ   ‚îú‚îÄ‚îÄ domain.ts            # –î–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ fs.ts                # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.html           # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ app.html             # –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îú‚îÄ‚îÄ styles.css           # –°—Ç–∏–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ app.js               # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π JavaScript
‚îú‚îÄ‚îÄ dist/                    # –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JS —Ñ–∞–π–ª—ã
‚îî‚îÄ‚îÄ package.json
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

ISC
